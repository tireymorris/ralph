#!/usr/bin/env ruby
# frozen_string_literal: true

require_relative 'agent'

# Main entry point for Ralph CLI
module Ralph
  class CLI
    def self.run(args)
      if args.empty? || args.include?('--help') || args.include?('-h')
        show_help
        return
      end

      # Parse arguments
      dry_run = args.include?('--dry-run')
      prompt_args = args.reject { |arg| arg == '--dry-run' }

      if prompt_args.empty?
        puts "âŒ Error: Please provide a prompt when using --dry-run"
        show_help
        return
      end

      prompt = prompt_args.join(' ')

      puts "ğŸ“ Request: #{prompt}"
      puts "ğŸ“ Working in: #{Dir.pwd}"
      puts "ğŸ¯ Mode: #{dry_run ? 'Dry run (PRD only)' : 'Full implementation'}"

      # Run Ralph
      Agent.run(prompt, dry_run: dry_run)
    end

    private

    def self.show_help
      puts <<~HELP
        Ralph - Autonomous Software Development Agent

        Usage:
          ./ralph "your feature description"           # Full implementation
          ./ralph "your feature description" --dry-run # Generate PRD only

        Examples:
          ./ralph "Add user authentication with login and registration"
          ./ralph "Implement REST API for user management" --dry-run

        Requirements:
          - opencode CLI tool installed and available
          - Git repository

        Features:
          - Autonomous software development through user stories
          - Comprehensive error handling and logging
          - Git-native workflow with automatic commits
          - Configurable timeouts and retry logic
          - Dry run mode for planning and review

        Configuration:
          Create ralph.config.json to customize settings:
          {
            "opencode_timeout": 300,
            "log_level": "info",
            "max_iterations": 50
          }

        For more information, see the README.md file.
      HELP
    end
  end
end

# Execute if run directly
if __FILE__ == $PROGRAM_NAME
  Ralph::CLI.run(ARGV)
end
